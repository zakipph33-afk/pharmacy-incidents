<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ’¼ Tableau de Bord Administrateur</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- PWA Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Incidents PPH">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/images/icon-192x192.png">
</head>
<body>
    <div class="container">
        <div class="navbar">
            <div class="navbar-brand">ğŸ‘¨â€ğŸ’¼ Tableau de Bord Administrateur</div>
            <div class="navbar-user">
                <button class="btn btn-primary" onclick="requestNotificationPermission()" style="width: auto; padding: 8px 20px; margin-right: 10px;" title="Activer les notifications">
                    ğŸ””
                </button>
                <span id="userName">Administrateur</span>
                <button class="btn btn-danger" id="logoutBtn" style="width: auto; padding: 8px 20px;">ğŸšª DÃ©connexion</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="card" style="text-align: center; padding: 20px;">
                <h3 style="color: #667eea; font-size: 40px; margin: 0;" id="totalIncidents">0</h3>
                <p style="color: #718096; margin-top: 10px;">Total des rapports</p>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <h3 style="color: #f59e0b; font-size: 40px; margin: 0;" id="pendingIncidents">0</h3>
                <p style="color: #718096; margin-top: 10px;">En attente</p>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <h3 style="color: #10b981; font-size: 40px; margin: 0;" id="resolvedIncidents">0</h3>
                <p style="color: #718096; margin-top: 10px;">RÃ©solus</p>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ Tous les Rapports</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <select class="form-select" id="filterStatus" style="width: auto; min-width: 200px;">
                    <option value="">Tous les statuts</option>
                    <option value="pending">En attente</option>
                    <option value="reviewed">ExaminÃ©</option>
                    <option value="resolved">RÃ©solu</option>
                </select>
                <select class="form-select" id="filterService" style="width: auto; min-width: 200px;">
                    <option value="">Tous les services</option>
                    <option value="oncology">Oncologie</option>
                    <option value="hematology">HÃ©matologie</option>
                    <option value="pediatric">PÃ©diatrie</option>
                </select>
                <button class="btn btn-primary" id="refreshBtn" style="width: auto; padding: 10px 25px;">ğŸ”„ Actualiser</button>
            </div>

            <div id="alertMessage" class="alert hidden"></div>
            <div class="spinner show" id="loadingSpinner"></div>

            <div id="reportsContainer" class="hidden">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ“… Date</th>
                                <th>ğŸ‘¤ DÃ©clarant</th>
                                <th>ğŸ¥ Service</th>
                                <th>ğŸ’Š MÃ©dicament</th>
                                <th>ğŸ“ Description</th>
                                <th>ğŸ›¡ï¸ EPI</th>
                                <th>ğŸ“· Photo</th>
                                <th>ğŸ“Š Statut</th>
                                <th>âš™ï¸ Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="noReportsMessage" class="hidden" style="text-align: center; padding: 40px;">
                <h3 style="color: #718096;">ğŸ“‹ Aucun rapport</h3>
            </div>
        </div>
    </div>

    <div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card" style="max-width: 400px; margin: 20px;">
            <h3>Modifier le statut du rapport</h3>
            <div class="form-group">
                <label class="form-label">Nouveau statut</label>
                <select class="form-select" id="newStatus">
                    <option value="pending">En attente</option>
                    <option value="reviewed">ExaminÃ©</option>
                    <option value="resolved">RÃ©solu</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmStatusBtn">Confirmer</button>
                <button class="btn btn-secondary" onclick="document.getElementById('statusModal').style.display='none'">Annuler</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm'

        const SUPABASE_URL = 'https://tewlugshhfcgkujgovjb.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRld2x1Z3NoaGZjZ2t1amdvdmpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjU5NTAsImV4cCI6MjA4MDg0MTk1MH0.ECW1RQ1tJveR0vc3R297nvG-jvCwKqmkCUaFHUEK2hc'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

        const user = JSON.parse(localStorage.getItem('user'))
        if (!user || user.role !== 'admin') {
            alert('âŒ AccÃ¨s refusÃ©')
            window.location.href = 'index.html'
        }

        document.getElementById('userName').textContent = user.name

        const loadingSpinner = document.getElementById('loadingSpinner')
        const reportsContainer = document.getElementById('reportsContainer')
        const noReportsMessage = document.getElementById('noReportsMessage')
        const reportsTableBody = document.getElementById('reportsTableBody')
        const alertMessage = document.getElementById('alertMessage')
        const filterStatus = document.getElementById('filterStatus')
        const filterService = document.getElementById('filterService')

        let currentIncidentId = null
        let allIncidents = []

        function showAlert(message, type) {
            alertMessage.textContent = message
            alertMessage.className = 'alert alert-' + type
            alertMessage.classList.remove('hidden')
            window.scrollTo({ top: 0, behavior: 'smooth' })
            setTimeout(() => alertMessage.classList.add('hidden'), 5000)
        }

        function getServiceNameFr(service) {
            const names = { 'oncology': 'Oncologie', 'hematology': 'HÃ©matologie', 'pediatric': 'PÃ©diatrie' }
            return names[service] || service
        }

        function getStatusText(status) {
            const statuses = {
                'pending': { text: 'En attente', class: 'status-pending' },
                'reviewed': { text: 'ExaminÃ©', class: 'status-reviewed' },
                'resolved': { text: 'RÃ©solu', class: 'status-resolved' }
            }
            return statuses[status] || { text: status, class: 'status-pending' }
        }

        function formatDate(dateString) {
            const date = new Date(dateString)
            return date.toLocaleDateString('fr-FR', { 
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            })
        }

        function getPPEList(incident) {
            const ppe = []
            if (incident.wearing_gloves) ppe.push('ğŸ§¤')
            if (incident.wearing_gown) ppe.push('ğŸ‘”')
            if (incident.wearing_cap) ppe.push('ğŸ§¢')
            if (incident.wearing_apron) ppe.push('ğŸ¦º')
            if (incident.wearing_shoe_covers) ppe.push('ğŸ‘Ÿ')
            return ppe.length > 0 ? ppe.join(' ') : 'âŒ'
        }

        function updateStats(incidents) {
            const total = incidents.length
            const pending = incidents.filter(i => i.status === 'pending').length
            const resolved = incidents.filter(i => i.status === 'resolved').length
            
            document.getElementById('totalIncidents').textContent = total
            document.getElementById('pendingIncidents').textContent = pending
            document.getElementById('resolvedIncidents').textContent = resolved
        }

        async function loadReports() {
            try {
                loadingSpinner.classList.add('show')
                
                const { data: incidents, error: incidentsError } = await supabase
                    .from('incidents')
                    .select('*, users (full_name, email, department)')
                    .order('created_at', { ascending: false })

                if (incidentsError) throw incidentsError

                allIncidents = incidents || []
                loadingSpinner.classList.remove('show')

                if (allIncidents.length === 0) {
                    noReportsMessage.classList.remove('hidden')
                    reportsContainer.classList.add('hidden')
                    return
                }

                updateStats(allIncidents)
                displayReports(allIncidents)

            } catch (error) {
                loadingSpinner.classList.remove('show')
                console.error('Erreur:', error)
                showAlert('Erreur: ' + error.message, 'danger')
            }
        }

        function displayReports(incidents) {
            if (incidents.length === 0) {
                noReportsMessage.classList.remove('hidden')
                reportsContainer.classList.add('hidden')
                return
            }

            noReportsMessage.classList.add('hidden')
            reportsContainer.classList.remove('hidden')
            
            reportsTableBody.innerHTML = incidents.map(inc => {
                const statusInfo = getStatusText(inc.status)
                return '<tr style="cursor: pointer;" data-id="' + inc.id + '"><td>' + formatDate(inc.incident_time) + '</td><td><strong>' + (inc.users?.full_name || 'Inconnu') + '</strong><br><small style="color: #718096;">' + (inc.users?.email || '') + '</small></td><td>' + getServiceNameFr(inc.service) + '</td><td><strong>' + inc.drug_name + '</strong><br><small>' + inc.drug_number + '</small></td><td>' + (inc.incident_description ? (inc.incident_description.substring(0, 30) + '...') : 'Aucune') + '</td><td style="font-size: 18px;">' + getPPEList(inc) + '</td><td>' + (inc.incident_image_url ? '<a href="' + inc.incident_image_url + '" target="_blank" style="text-decoration: none;">ğŸ“· Voir</a>' : 'âŒ') + '</td><td><span class="status-badge ' + statusInfo.class + '">' + statusInfo.text + '</span></td><td><button class="btn btn-primary view-btn" data-id="' + inc.id + '" style="padding: 6px 12px; font-size: 13px; width: auto; margin-bottom: 5px;">ğŸ‘ï¸ Voir</button><button class="btn btn-success modify-btn" data-id="' + inc.id + '" data-status="' + inc.status + '" style="padding: 6px 12px; font-size: 13px; width: auto;">ğŸ”„ Modifier</button></td></tr>'
            }).join('')

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation()
                    showDetails(e.target.getAttribute('data-id'))
                })
            })

            document.querySelectorAll('.modify-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation()
                    changeStatus(e.target.getAttribute('data-id'), e.target.getAttribute('data-status'))
                })
            })
        }

        function showDetails(id) {
    const inc = allIncidents.find(i => i.id === id)
    if (!inc) return

    const modal = document.createElement('div')
    modal.id = 'detailModal'
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center;'
    
    const card = document.createElement('div')
    card.className = 'card'
    card.style.cssText = 'max-width: 700px; margin: 20px; max-height: 90vh; overflow-y: auto;'
    
    const header = document.createElement('div')
    header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;'
    header.innerHTML = '<h3>ğŸ“‹ DÃ©tails du Rapport</h3><button class="close-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #718096;">âœ•</button>'
    
    const content = document.createElement('div')
    content.id = 'printContent'
    content.innerHTML = `
        <p><strong>ğŸ‘¤ DÃ©clarant:</strong> ${inc.users?.full_name || 'Inconnu'}</p>
        <p><strong>ğŸ“§ Email:</strong> ${inc.users?.email || 'N/A'}</p>
        <p><strong>ğŸ¥ Service:</strong> ${getServiceNameFr(inc.service)}</p>
        <p><strong>ğŸ’Š MÃ©dicament:</strong> ${inc.drug_name}</p>
        <p><strong>ğŸ”¢ NumÃ©ro:</strong> ${inc.drug_number}</p>
        <p><strong>ğŸ“… Date:</strong> ${formatDate(inc.incident_time)}</p>
        <p><strong>ğŸ“ Description:</strong> ${inc.incident_description || 'Aucune'}</p>
        <p><strong>ğŸ›¡ï¸ EPI:</strong><br>
            ${inc.wearing_gloves ? 'âœ…' : 'âŒ'} Gants<br>
            ${inc.wearing_gown ? 'âœ…' : 'âŒ'} Blouse<br>
            ${inc.wearing_cap ? 'âœ…' : 'âŒ'} Calot<br>
            ${inc.wearing_apron ? 'âœ…' : 'âŒ'} Lunettes<br>
            ${inc.wearing_shoe_covers ? 'âœ…' : 'âŒ'} Masque
        </p>
        ${inc.incident_image_url ? '<p><strong>ğŸ“· Photo:</strong><br><img src="' + inc.incident_image_url + '" style="max-width: 100%; border-radius: 10px;"></p>' : ''}
    `
    
    const buttons = document.createElement('div')
    buttons.style.cssText = 'display: flex; gap: 10px; margin-top: 20px;'
    buttons.className = 'no-print'
    buttons.innerHTML = `
        <button class="btn btn-primary print-btn" style="width: auto; padding: 10px 20px;">ğŸ–¨ï¸ Imprimer</button>
        <button class="btn btn-secondary close-btn2" style="width: auto; padding: 10px 20px;">Fermer</button>
    `
    
    card.appendChild(header)
    card.appendChild(content)
    card.appendChild(buttons)
    modal.appendChild(card)
    document.body.appendChild(modal)
    
    // Ø¥ØºÙ„Ø§Ù‚ Modal
    modal.querySelector('.close-btn').onclick = () => modal.remove()
    modal.querySelector('.close-btn2').onclick = () => modal.remove()
    modal.onclick = (e) => {
        if (e.target.id === 'detailModal') modal.remove()
    }
    
    // Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    modal.querySelector('.print-btn').onclick = () => {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
        buttons.style.display = 'none'
        
        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const printContent = card.innerHTML
        const originalContent = document.body.innerHTML
        
        document.body.innerHTML = `
            <div style="padding: 40px; max-width: 800px; margin: 0 auto;">
                <h1 style="color: #667eea; text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                    ğŸ¥ Rapport d'Incident de ChimiothÃ©rapie
                </h1>
                ${printContent}
            </div>
        `
        
        window.print()
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ
        document.body.innerHTML = originalContent
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        location.reload()
    }
}

        function changeStatus(id, currentStatus) {
            currentIncidentId = id
            document.getElementById('newStatus').value = currentStatus
            document.getElementById('statusModal').style.display = 'flex'
        }

        function applyFilters() {
            let filtered = allIncidents
            if (filterStatus.value) filtered = filtered.filter(i => i.status === filterStatus.value)
            if (filterService.value) filtered = filtered.filter(i => i.service === filterService.value)
            displayReports(filtered)
        }

        document.getElementById('confirmStatusBtn').addEventListener('click', async () => {
            try {
                const { error } = await supabase.from('incidents').update({ status: document.getElementById('newStatus').value }).eq('id', currentIncidentId)
                if (error) throw error
                document.getElementById('statusModal').style.display = 'none'
                showAlert('âœ… Statut mis Ã  jour', 'success')
                loadReports()
            } catch (error) {
                showAlert('âŒ Erreur: ' + error.message, 'danger')
            }
        })

        filterStatus.addEventListener('change', applyFilters)
        filterService.addEventListener('change', applyFilters)
        document.getElementById('refreshBtn').addEventListener('click', () => {
            filterStatus.value = ''
            filterService.value = ''
            loadReports()
        })
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut()
            localStorage.removeItem('user')
            window.location.href = 'index.html'
        })

        loadReports()
        // ========================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
// ========================================

let lastIncidentCount = 0
let notificationCheckInterval = null

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function requestNotificationPermission() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª')
                    showAlert('âœ… Les notifications sont activÃ©es', 'info')
                } else {
                    console.log('âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª')
                }
            })
        }
    } else {
        console.log('âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª')
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡
function playNotificationSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)()
        
        // Ù†ØºÙ…Ø© Ù…Ù†Ø®ÙØ¶Ø©
        const osc1 = audioContext.createOscillator()
        const gain1 = audioContext.createGain()
        osc1.connect(gain1)
        gain1.connect(audioContext.destination)
        osc1.frequency.value = 600
        osc1.type = 'sine'
        gain1.gain.setValueAtTime(0.2, audioContext.currentTime)
        gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2)
        osc1.start(audioContext.currentTime)
        osc1.stop(audioContext.currentTime + 0.2)
        
        // Ù†ØºÙ…Ø© Ø¹Ø§Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
        setTimeout(() => {
            const osc2 = audioContext.createOscillator()
            const gain2 = audioContext.createGain()
            osc2.connect(gain2)
            gain2.connect(audioContext.destination)
            osc2.frequency.value = 900
            osc2.type = 'sine'
            gain2.gain.setValueAtTime(0.2, audioContext.currentTime)
            gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3)
            osc2.start(audioContext.currentTime)
            osc2.stop(audioContext.currentTime + 0.3)
        }, 100)
        
    } catch (error) {
        console.log('âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª')
    }
}
// Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
function showBrowserNotification(title, body, icon = 'ğŸ””') {
    if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(title, {
            body: body,
            icon: icon,
            badge: 'ğŸ¥',
            tag: 'new-incident',
            requireInteraction: false,
            silent: false
        })
        
        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        notification.onclick = function() {
            window.focus()
            notification.close()
            loadReports() // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => notification.close(), 10000)
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
async function checkForNewIncidents() {
    try {
        console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ‚Ø§Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯Ø©...')
        
        const { data, error } = await supabase
            .from('incidents')
            .select('id, drug_name, created_at, service, users(full_name)')
            .order('created_at', { ascending: false })
        
        if (error) throw error
        
        const currentCount = data.length
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªÙ‚Ø§Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯Ø©
        if (lastIncidentCount > 0 && currentCount > lastIncidentCount) {
            const newIncidentsCount = currentCount - lastIncidentCount
            const latestIncident = data[0]
            
            console.log(`ğŸ”” ${newIncidentsCount} ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯!`)
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
            const message = newIncidentsCount === 1 
                ? `ğŸ”” Nouveau rapport: ${latestIncident.drug_name}` 
                : `ğŸ”” ${newIncidentsCount} nouveaux rapports reÃ§us!`
            
            showAlert(message, 'info')
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            playNotificationSound()
            
            // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­
            const notificationBody = newIncidentsCount === 1
                ? `${latestIncident.users?.full_name || 'Un utilisateur'} a dÃ©clarÃ© un incident: ${latestIncident.drug_name}`
                : `${newIncidentsCount} nouveaux rapports d'incidents reÃ§us`
            
            showBrowserNotification(
                'ğŸ¥ Nouveau(x) Rapport(s) d\'Incident',
                notificationBody
            )
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            loadReports()
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const totalElement = document.getElementById('totalIncidents')
            totalElement.style.animation = 'none'
            setTimeout(() => {
                totalElement.style.animation = 'pulse 0.5s ease'
            }, 10)
        }
        
        lastIncidentCount = currentCount
        
    } catch (error) {
        console.error('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:', error)
    }
}

// Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Pulse Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
const style = document.createElement('style')
style.textContent = `
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); color: #48bb78; }
    }
`
document.head.appendChild(style)

// Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function startNotificationSystem() {
    console.log('ğŸ”” ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...')
    
    // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
    requestNotificationPermission()
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    lastIncidentCount = allIncidents.length
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    notificationCheckInterval = setInterval(checkForNewIncidents, 30000)
    
    console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù†Ø´Ø· - Ø§Ù„ØªØ­Ù‚Ù‚ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©')
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ù…Ø±Ø¦ÙŠ
    const navbar = document.querySelector('.navbar-brand')
    const indicator = document.createElement('span')
    indicator.innerHTML = ' <span style="color: #48bb78; font-size: 12px;" title="Notifications actives">ğŸ”” Actif</span>'
    navbar.appendChild(indicator)
}

// Ø¥ÙŠÙ‚Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', () => {
    if (notificationCheckInterval) {
        clearInterval(notificationCheckInterval)
        console.log('ğŸ”• ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª')
    }
})

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
loadReports().then(() => {
    startNotificationSystem()
})
    </script>
    <!-- Ø²Ø± Dark Mode -->
<button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†">
    <span id="darkModeIcon">ğŸŒ™</span>
</button>

<script>
    // Dark Mode Toggle
    function toggleDarkMode() {
        const html = document.documentElement
        const icon = document.getElementById('darkModeIcon')
        
        if (html.getAttribute('data-theme') === 'dark') {
            html.removeAttribute('data-theme')
            icon.textContent = 'ğŸŒ™'
            localStorage.setItem('theme', 'light')
        } else {
            html.setAttribute('data-theme', 'dark')
            icon.textContent = 'â˜€ï¸'
            localStorage.setItem('theme', 'dark')
        }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme')
        const icon = document.getElementById('darkModeIcon')
        
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark')
            if (icon) icon.textContent = 'â˜€ï¸'
        }
    })
</script>
<!-- ØªØ³Ø¬ÙŠÙ„ Service Worker -->
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('âœ… Service Worker registered successfully:', registration.scope);
          })
          .catch(error => {
            console.log('âŒ Service Worker registration failed:', error);
          });
      });
    }
    </script>
</body>
</html>