<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ… Mes Rapports</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- PWA Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Incidents PPH">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/images/icon-192x192.png">
</head>
<body>
    <div class="container">
        <!-- Barre de navigation -->
        <div class="navbar">
            <div class="navbar-brand">ğŸ¥ SystÃ¨me de DÃ©claration d'Incidents</div>
            <div class="navbar-user">
                <span id="userName">Utilisateur</span>
                <button class="btn btn-primary" id="newReportBtn" style="width: auto; padding: 8px 20px; margin-left: 10px;">
                    â• Nouveau rapport
                </button>
                <button class="btn btn-danger" id="logoutBtn" style="width: auto; padding: 8px 20px;">
                    ğŸšª DÃ©connexion
                </button>
            </div>
        </div>

        <!-- Carte principale -->
        <div class="card">
            <h2>ğŸ“Š Mes Rapports PrÃ©cÃ©dents</h2>
            
            <!-- Messages d'alerte -->
            <div id="alertMessage" class="alert hidden"></div>

            <!-- Loading Spinner -->
            <div class="spinner show" id="loadingSpinner"></div>

            <!-- Tableau des rapports -->
            <div id="reportsContainer" class="hidden">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ“… Date</th>
                                <th>ğŸ¥ Service</th>
                                <th>ğŸ’Š MÃ©dicament</th>
                                <th>ğŸ”¢ NumÃ©ro</th>
                                <th>ğŸ“ Description</th>
                                <th>ğŸ›¡ï¸ EPI</th>
                                <th>ğŸ“· Photo</th>
                                <th>ğŸ“Š Statut</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Sera rempli automatiquement -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Message d'absence de rapports -->
            <div id="noReportsMessage" class="hidden" style="text-align: center; padding: 40px;">
                <h3 style="color: #718096;">ğŸ“‹ Aucun rapport pour le moment</h3>
                <p style="color: #a0aec0; margin-top: 10px;">Commencez par crÃ©er votre premier rapport</p>
                <button class="btn btn-primary" onclick="window.location.href='report.html'" style="margin-top: 20px; width: auto; padding: 12px 30px;">
                    â• CrÃ©er un nouveau rapport
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour afficher les dÃ©tails du rapport -->
    <div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="card" style="max-width: 600px; margin: 20px; max-height: 90vh; overflow-y: auto;">
            <h3>ğŸ“‹ DÃ©tails du Rapport</h3>
            <div id="modalContent"></div>
            <button class="btn btn-secondary" onclick="document.getElementById('detailsModal').style.display='none'">
                Fermer
            </button>
        </div>
    </div>

    <script type="module">
        // ========================================
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
        // ========================================
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm'

        // âš ï¸âš ï¸âš ï¸ Ø¶Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù‡Ù†Ø§ âš ï¸âš ï¸âš ï¸
        const SUPABASE_URL = 'https://tewlugshhfcgkujgovjb.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRld2x1Z3NoaGZjZ2t1amdvdmpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjU5NTAsImV4cCI6MjA4MDg0MTk1MH0.ECW1RQ1tJveR0vc3R297nvG-jvCwKqmkCUaFHUEK2hc'
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

        console.log('âœ… ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§')

        // ========================================
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // ========================================
        const user = JSON.parse(localStorage.getItem('user'))
        if (!user) {
            alert('âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!')
            window.location.href = 'index.html'
        }

        console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user)

        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById('userName').textContent = user.name

        // ========================================
        // Ø§Ù„Ø¹Ù†Ø§ØµØ±
        // ========================================
        const loadingSpinner = document.getElementById('loadingSpinner')
        const reportsContainer = document.getElementById('reportsContainer')
        const noReportsMessage = document.getElementById('noReportsMessage')
        const reportsTableBody = document.getElementById('reportsTableBody')
        const alertMessage = document.getElementById('alertMessage')

        // ========================================
        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ========================================
        function showAlert(message, type) {
            alertMessage.textContent = message
            alertMessage.className = `alert alert-${type}`
            alertMessage.classList.remove('hidden')
            setTimeout(() => alertMessage.classList.add('hidden'), 5000)
        }

        function getServiceNameFr(service) {
            const names = {
                'oncology': 'Oncologie',
                'hematology': 'HÃ©matologie',
                'pediatric': 'PÃ©diatrie'
            }
            return names[service] || service
        }

        function getStatusText(status) {
            const statuses = {
                'pending': { text: 'En attente', class: 'status-pending' },
                'reviewed': { text: 'ExaminÃ©', class: 'status-reviewed' },
                'resolved': { text: 'RÃ©solu', class: 'status-resolved' }
            }
            return statuses[status] || { text: status, class: 'status-pending' }
        }

        function formatDate(dateString) {
            const date = new Date(dateString)
            return date.toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })
        }

        function getPPEList(incident) {
            const ppe = []
            if (incident.wearing_gloves) ppe.push('ğŸ§¤ Gants')
            if (incident.wearing_gown) ppe.push('ğŸ‘” Blouse')
            if (incident.wearing_cap) ppe.push('ğŸ§¢ Calot')
            if (incident.wearing_apron) ppe.push('ğŸ¦º Tablier')
            if (incident.wearing_shoe_covers) ppe.push('ğŸ‘Ÿ Surchaussures')
            return ppe.length > 0 ? ppe.join('<br>') : 'âŒ Aucun'
        }

        // ========================================
        // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        // ========================================
        async function loadReports() {
            try {
                console.log('ğŸ”µ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...')
                
                const { data, error } = await supabase
                    .from('incidents')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })

                console.log('ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©:', { data, error })

                if (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:', error)
                    throw error
                }

                loadingSpinner.classList.remove('show')

                if (!data || data.length === 0) {
                    console.log('ğŸ“‹ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ±')
                    noReportsMessage.classList.remove('hidden')
                    return
                }

                console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.length} ØªÙ‚Ø±ÙŠØ±`)
                reportsContainer.classList.remove('hidden')
                
                // Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                reportsTableBody.innerHTML = data.map(incident => `
                    <tr onclick="showDetails('${incident.id}')" style="cursor: pointer;">
                        <td>${formatDate(incident.incident_time)}</td>
                        <td>${getServiceNameFr(incident.service)}</td>
                        <td>${incident.drug_name}</td>
                        <td>${incident.drug_number}</td>
                        <td>${incident.incident_description ? (incident.incident_description.substring(0, 30) + '...') : 'Aucune'}</td>
                        <td style="font-size: 12px;">${getPPEList(incident)}</td>
                        <td>${incident.incident_image_url ? 'âœ… Oui' : 'âŒ Non'}</td>
                        <td><span class="status-badge ${getStatusText(incident.status).class}">${getStatusText(incident.status).text}</span></td>
                    </tr>
                `).join('')

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙØ§ØµÙŠÙ„
                window.incidentsData = data

            } catch (error) {
                loadingSpinner.classList.remove('show')
                console.error('âŒâŒâŒ Ø®Ø·Ø£ ÙƒØ¨ÙŠØ±:', error)
                showAlert('âŒ Une erreur s\'est produite lors du chargement des rapports: ' + error.message, 'danger')
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ±" ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                noReportsMessage.classList.remove('hidden')
            }
        }

        // ========================================
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        // ========================================
        window.showDetails = function(id) {
            console.log('ğŸ” Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', id)
            const incident = window.incidentsData.find(i => i.id === id)
            if (!incident) return

            const modal = document.getElementById('detailsModal')
            const content = document.getElementById('modalContent')

            content.innerHTML = `
                <div style="line-height: 2;">
                    <p><strong>ğŸ¥ Service:</strong> ${getServiceNameFr(incident.service)}</p>
                    <p><strong>ğŸ’Š Nom du mÃ©dicament:</strong> ${incident.drug_name}</p>
                    <p><strong>ğŸ”¢ NumÃ©ro du mÃ©dicament:</strong> ${incident.drug_number}</p>
                    <p><strong>ğŸ“… Heure de l'incident:</strong> ${formatDate(incident.incident_time)}</p>
                    <p><strong>ğŸ“ Description:</strong> ${incident.incident_description || 'Aucune'}</p>
                    <p><strong>ğŸ›¡ï¸ Ã‰quipements de protection:</strong><br>${getPPEList(incident)}</p>
                    <p><strong>ğŸ“Š Statut:</strong> <span class="status-badge ${getStatusText(incident.status).class}">${getStatusText(incident.status).text}</span></p>
                    ${incident.incident_image_url ? `<p><strong>ğŸ“· Photo:</strong><br><img src="${incident.incident_image_url}" style="max-width: 100%; border-radius: 10px; margin-top: 10px;"></p>` : ''}
                </div>
            `

            modal.style.display = 'flex'
        }

        // ========================================
        // Ø¥ØºÙ„Ø§Ù‚ Modal
        // ========================================
        document.getElementById('detailsModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailsModal') {
                e.target.style.display = 'none'
            }
        })

        // ========================================
        // Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        // ========================================
        document.getElementById('newReportBtn').addEventListener('click', () => {
            window.location.href = 'report.html'
        })

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            console.log('ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬...')
            await supabase.auth.signOut()
            localStorage.removeItem('user')
            window.location.href = 'index.html'
        })

        // ========================================
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        // ========================================
        loadReports()
    </script>
    <!-- Ø²Ø± Dark Mode -->
<button class="dark-mode-toggle" onclick="toggleDarkMode()" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†">
    <span id="darkModeIcon">ğŸŒ™</span>
</button>

<script>
    // Dark Mode Toggle
    function toggleDarkMode() {
        const html = document.documentElement
        const icon = document.getElementById('darkModeIcon')
        
        if (html.getAttribute('data-theme') === 'dark') {
            html.removeAttribute('data-theme')
            icon.textContent = 'ğŸŒ™'
            localStorage.setItem('theme', 'light')
        } else {
            html.setAttribute('data-theme', 'dark')
            icon.textContent = 'â˜€ï¸'
            localStorage.setItem('theme', 'dark')
        }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme')
        const icon = document.getElementById('darkModeIcon')
        
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark')
            if (icon) icon.textContent = 'â˜€ï¸'
        }
    })
</script>
<!-- ØªØ³Ø¬ÙŠÙ„ Service Worker -->
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('âœ… Service Worker registered successfully:', registration.scope);
          })
          .catch(error => {
            console.log('âŒ Service Worker registration failed:', error);
          });
      });
    }
    </script>
</body>
</html>